<?php      class Live extends CI_Controller{          function index()          {  			if($this->session->userdata('username')  == TRUE)			{				$data['username'] = $this->session->userdata('username');				$data['page'] = 'signup_view.php';				$this->load->view('live_view',$data);			}else 			{				$data['page'] = 'signup_view.php';				$this->load->view('live_view',$data);			}			        }		function checklogin()		{			$this->load->model('live_model'); 			$this->load->library('session');						$a['username'] = $this->input->post('username');			$a['password'] = $this->input->post('password');			$username = $a['username'];			$ret = $this->live_model->login($a) ;			if($ret != -1)			{			$uid = $this->live_model->get_userid_byname($username);			$data = array(                   'username'  => $username,				   'user_id' => $uid,                   'logged'  => TRUE                );                $this->session->set_userdata($data);				redirect('live/welcome');				return;			}			else echo 'bad password';			$this->load->view('done_view');			return;		}		function welcome()		{			$this->load->model('live_model'); 			$da['page'] = 'welcome.php';			$da['username'] = $this->session->userdata['username'];			$this->load->view('live_view',$da);		}		function signup()		{			$da['page'] = 'signup_view.php';			$this->load->view('live_view',$da);		}		function logout()		{			$this->session->sess_destroy();			redirect('live/signup');			return;		}		function newUser()		{		//------------- insert new user ----------------//			$this->load->model('live_model'); 						$arr['first_name']=$this->input->post('first_name');			$arr['last_name']=$this->input->post('last_name');			$arr['username']=$this->input->post('username');			$arr['password']=$this->input->post('password');			$arr['email']=$this->input->post('email');			$arr['country_id']=1;//$this->input->post('country_id');			$arr['reg_date']=time();			$arr['sex']=0;			$arr['last_login_date']=time();			$this->live_model->insert_user($arr);						$uid = $this->live_model->get_userid_byname($arr['username']);			$da = array(				'username' => $arr['username'],				'user_id' => $uid,				'logged' => true				);			$this->session->set_userdata($da);						$data['page'] = 'create_channel_view.php';			$data['user_id'] = $uid;			$this->load->view('live_view',$data);		} 		function createChannel()		{			$this->load->model('live_model');			$arr['name'] = $this->input->post('channel_name');			$arr['user_id'] = $this->session->userdata('user_id');			$arr['disc'] = $this->input->post('channel_disc');			$arr['creation_date'] = time();				$this->live_model->insert_channel($arr);						//$data['page'] = 'live_view.php';			//$data['user_id'] = $this->session->userdata('user_id');			$this->load->view('done_view',$data);		}		function upload()		{			$this->load->model('live_model'); 			$x = $this->session->userdata('user_id');			if($x != 0)			{				$channel_id = $this->live_model->get_channelid_byuserid($x);								$da = array(					'channel_id' => $channel_id						);					$this->session->set_userdata($da);									$data['page'] = 'upload_video.php';					$data['username'] = $this->session->userdata('username');					$this->load->view('live_view',$data);			}		}		function do_upload2()		{			$uploaddir = 'tmp/';			$fname = $_FILES['fx'];			if (is_uploaded_file($fname['tmp_name']))			{			$filname = basename($fname['name']);			$uploadfile = $uploaddir . basename($fname['name']);						if (move_uploaded_file ($fname['tmp_name'], $uploadfile))			{			//$res = "File " . $filname . " was successfully uploaded and stored.<br>";							$x = rand();				$filename2 = 'uploads/' . $x . '.flv' ;				while (file_exists($filename2)) {					$x = rand();					$filename2 = 'uploads/' . $x . '.flv' ;				}				$s = 'ffmpeg -i tmp/'. $filname . ' -f flv uploads/' . $x . '.flv';				$t = 'ffmpeg -ss 60 -i tmp/' . $filname . ' -an -vframes 1 thumbs/' . $x . '.png';				//$y = 'del ' . uploadfile ;				exec($s);				exec($t);				$thumbfile = 'thumbs/' . $x . '.png';				$ix = 30;				while ( (file_exists($thumbfile) == FALSE)  AND ($ix > 0) ) {					$t = 'ffmpeg -ss ' . $ix . ' -i tmp/' . $filname . ' -an -vframes 1 thumbs/' . $x . '.png';					exec($t);					$ix/=2;				}								//exec($y);											$this->load->model('live_model');				$arr['name'] = $this->input->post('name');				$arr['channel_id'] = $this->session->userdata('channel_id');				$arr['view'] = 1;				$arr['date'] = time();				$arr['desc'] = $this->input->post('desc');				$arr['access_id'] = 1;				$arr['link'] = $filename2;				$arr['thumb'] = $thumbfile;				$video_id = $this->live_model->insert_video($arr);								redirect('live/show/'.$video_id);				return;							}			else			$res = "Could not move ".$fname['tmp_name']." to ".$uploadfile."<br>";			}			else			$res = "File ".$fname['name']." failed to upload.";			echo ($res);		}		function show($id)		{			$this->load->model('live_model');			if($id <=0) 			{				$data['page'] = '404.php';				$this->load->view('live_view',$data);				return ;			}			$data['filepath']=$this->live_model->get_videolink_byid($id);			$data['video_id'] = $id;			$data['comments'] = $this->live_model->get_comments_byvideoid($id);			$data['cc'] = array("one", "two", "three");			if($this->session->userdata('username')  == TRUE)				$data['username'] = $this->session->userdata('username');			$data['page'] = 'show.php';			$this->load->view('live_view',$data);		}						//------------ADD RATE FUNCTION----------------//				function add_rate()		{			$this->load->model('live_model'); 									$arr['video_id']=1;//$this->input->post('video_id');			$arr['user_id']=1;//$this->input->post('user_id');			$arr['value']=$this->input->post('value');						$this->live_model->insert_rate($arr) ;  			$this->load->view('done_view');        }		function new_comment()		{			$this->load->model('live_model'); 						if($this->session->userdata('username')  == TRUE){				$arr['username'] = $this->session->userdata('username');				$arr['user_id'] = $this->session->userdata('user_id');			}			else {					$arr['email'] = $this->input->post('email');				$arr['username'] = $this->input->post('username');				$arr['user_id'] = 1;			}			$arr['text'] = $this->input->post('text');			$arr['date'] = time();			$vid_id = $this->input->post('video_id');			$arr['video_id'] = $vid_id;			$this->live_model->insert_comment($arr);			redirect('live/show/'.$vid_id);		}		function movies()		{			$this->load->model('live_model'); 			if($this->session->userdata('username')  == TRUE)				$data['username'] = $this->session->userdata('username');			$data['movies'] = $this->live_model->get_videos();			$data['page'] = 'movies.php';			$this->load->view('live_view',$data);		}		function live_channels()		{			$this->load->model('live_model'); 			if($this->session->userdata('username')  == TRUE)				$data['username'] = $this->session->userdata('username');						$data['channels'] = $this->live_model->get_live_channels();			$data['server'] = 'rtmp://localhost/live/';			$data['page'] = 'live_channels.php';			$this->load->view('live_view',$data);				}		function subcribe($id)		{			$this->load->model('live_model'); 			if($this->session->userdata('username')  == TRUE)				$data['username'] = $this->session->userdata('username');						$data['channel'] = 'rtmp://172.17.17.102/live/' . 'c' . $id . '&type=live';			$data['page'] = 'subcribe.php';			$this->load->view('live_view',$data);				}		function publish($id)		{			$this->load->model('live_model'); 			if($this->session->userdata('username')  == TRUE)			{				$data['username'] = $this->session->userdata('username');									if(($id == FALSE) OR ($id == 0)) 				{					$data['page'] = '404.php';					$this->load->view('live_view',$data);					return;				}				$data['channel_id'] = $this->session->userdata('channel_id');				$data['page'] = 'publish.php';				$this->load->view('live_view',$data);					}			else 			{				$data['page'] = '404.php';				$this->load->view('live_view',$data);			}		}		function pub()		{			$this->load->model('live_model');			if($this->session->userdata('username')  == TRUE)			{				$x = $this->session->userdata('user_id');				$channel_id = $this->live_model->get_channelid_byuserid($x);				$uu = index_page() . 'live/publish/'.$channel_id;				$dd = 'http://localhost/ss';				$str=base_url();				$len=strlen($str);				$test=substr($str,0,($len-1));				$test = $test . '/index.php?/live/publish/'.$channel_id;				redirect($test);			}			else 			{				$data['page'] = '404.php';				$this->load->view('live_view',$data);			}		}				    }  